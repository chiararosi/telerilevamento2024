library(terra)
library(imageRy)
library(viridisLite)
library(viridis)
library(ggplot2)
library(patchwork) 
library(ggfortify)
library(factoextra)

#Anno 2020
list.files("C:/Users/kiko9/Downloads/esametele/2020")
setwd("C:/Users/kiko9/Downloads/esametele/2020")
Banda02_2020 <- rast ("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_B02_(Raw).tiff") 
Banda03_2020 <- rast ("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_B03_(Raw).tiff")
Banda04_2020 <- rast ("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_B04_(Raw).tiff")
Banda08_2020 <- rast ("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_B08_(Raw).tiff")
Banda8A_2020 <- rast ("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_B8A_(Raw).tiff")
Banda12_2020 <- rast ("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_B12_(Raw).tiff")


# Anno 2021
list.files("C:/Users/kiko9/Downloads/esametele/2021")
setwd("C:/Users/kiko9/Downloads/esametele/2021")
Banda02_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_B02_(Raw).tiff")
Banda03_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_B03_(Raw).tiff")
Banda04_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_B04_(Raw).tiff")
Banda08_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_B08_(Raw).tiff")
Banda8A_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_B8A_(Raw).tiff")
Banda12_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_B12_(Raw).tiff")

#Anno 2022
list.files("C:/Users/kiko9/Downloads/esametele/2022")
setwd("C:/Users/kiko9/Downloads/esametele/2022")
Banda02_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_B02_(Raw).tiff")
Banda03_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_B03_(Raw).tiff")
Banda04_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_B04_(Raw).tiff")
Banda08_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_B08_(Raw).tiff")
Banda8A_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_B8A_(Raw).tiff")
Banda12_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_B12_(Raw).tiff")

#Anno 2023
list.files("C:/Users/kiko9/Downloads/esametele/2023")
setwd("C:/Users/kiko9/Downloads/esametele/2023")
Banda02_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_B02_(Raw).tiff")
Banda03_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_B03_(Raw).tiff")
Banda04_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_B04_(Raw).tiff")
Banda08_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_B08_(Raw).tiff")
Banda8A_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_B8A_(Raw).tiff")
Banda12_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_B12_(Raw).tiff")


#Anno 2024
list.files("C:/Users/kiko9/Downloads/esametele/2024")
setwd("C:/Users/kiko9/Downloads/esametele/2024")
Banda02_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_B02_(Raw).tiff")
Banda03_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_B03_(Raw).tiff")
Banda04_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_B04_(Raw).tiff")
Banda08_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_B08_(Raw).tiff")
Banda8A_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_B8A_(Raw).tiff")
Banda12_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_B12_(Raw).tiff")




#Calcolo degli indici spettrali per l'anno 2020

setwd("C:/Users/kiko9/Downloads/esametele/2020")
list.files("C:/Users/kiko9/Downloads/esametele/2020")

TRUECOL_2020 <- rast("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_True_color.tiff")
plot(TRUECOL_2020)
NDWI_2020 <- rast( "2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_NDWI.tiff")
plot(NDWI_2020)

#multiframe
par(mfrow=c(1,2))
plot(TRUECOL_2020)
plot(NDWI_2020)
dev.off()

NDVI_2020 <- (Banda08_2020 - Banda04_2020) / (Banda08_2020 + Banda04_2020)
summary(NDVI_2020)
plot(NDVI_2020)
veg_mask_2020 <- NDVI_2020 > 0.3
plot(vegetazione_2020, main = "Maschera Vegetazione 2020")


# clusterizzazione dell'immagine dividendola in classi

plot(NDWI_2020, main= "Normalize Difference Water Index 2020")
IndexNDWI_2020 <-  (Banda03_2020 - Banda08_2020) / (Banda03_2020 + Banda08_2020)
summary(IndexNDWI_2020)
plot(IndexNDWI_2020)

rcl <- matrix(c(
  -Inf, -0.6, 1,   # Classe 1: Urbano o suolo molto secco # Riga 1: Valori da -Inf a -0.6 saranno classificati come 1
  -0.6, -0.4, 2,   # Classe 2: Suolo secco/nudo # Riga 2: Valori da -0.6 a -0.4 saranno classificati come 2
  -0.4, 0, 3,      # Classe 3: Vegetazione scarsa  # Riga 3: Valori da -0.4 a 0 saranno classificati come 3
  0, 0.2, 4,       # Classe 4: Vegetazione ricca o aree umide # Riga 4: Valori da 0 a 0.2 saranno classificati come 4
  0.2, Inf, 5      # Classe 5: Acqua # Riga 5: Valori da 0.2 a Inf saranno classificati come 5
), ncol = 3, byrow = TRUE)
 
classified_2020 <- classify(IndexNDWI_2020, rcl)

plot(classified_2020, col = viridis(100), main = "Classificazione 2020")

# calcolo la frequenza e la percentuale delle varie classi

FreqNDWI_2020 <- freq(classified_NDWI_2020)
FreqNDWI_2020
# per la 1° classe: 146896; 2° classe: 697564; 3° classe: 501171; 4° classe: 1024; 5° classe:  845 pixels

tot2020 <- ncell(NDWI_2020)
tot2020
#il numero di celle del raster NDWI_2020 sono 1347500 che è lo stesso di quello per IndexNDWI_2020
#la proporzione è la frequenza diviso il totale
prop2020 = FreqNDWI_2020 / tot2020
prop2020
# La 1° classe: 0.1090137291 10.90%; 2° classe: 0.5176727273 51.77%; 3° classe: 0.3719265306  37.19%; 4° classe: 0.0007599258 0.08%; 5° classe: 0.0006270872 0.06%
dev.off()

# composizione di una immagine in falsi colori SWIR-NIR-Rosso 
stack_2020 <- c(Banda12_2020, Banda08_2020, Banda04_2020)
im.plotRGB(stack_2020, r=1, g=2, b=3)

#aggiungo anche l'immagine della banda SWIR per riconoscere bene la vegetazione, il suolo nudo e la componente acquosa
SWIR_2020 <- rast("2020-05-25-00_00_2020-05-25-23_59_Sentinel-2_L1C_SWIR.tiff")
plot(SWIR_2020)

#multiframe
par(mfrow= c(1,3))
plot(TRUECOL2020)
plot(NDWI_2020)
im.plotRGB(stack_2020, r=1, g=2, b=3)
dev.off()


#Calcolo indici anno 2021
setwd("C:/Users/kiko9/Downloads/esametele/2021")
list.files("C:/Users/kiko9/Downloads/esametele/2021")

NDWI_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_NDWI.tiff")
TRUECOL_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_True_color.tiff")
SWIR_2021 <- rast ("2021-05-20-00_00_2021-05-20-23_59_Sentinel-2_L1C_SWIR.tiff")
par(mfrow=c(1,3))
plot(TRUECOL_2021)
plot(NDWI_2021)
plot(SWIR_2021)

dev.off()

#calcolo NDVI

NDVI_2021 <- (Banda08_2021 - Banda04_2021) / (Banda08_2021 + Banda04_2021)
summary(NDVI_2021)
veg_mask_2021 <- NDVI_2021 > 0.3
plot(veg_mask_2021, main = "Maschera Vegetazione 2021")

#classificazione in classi

plot(NDWI_2021, main= "Normalize Difference Water Index 2020")
IndexNDWI_2021 <-  (Banda03_2021 - Banda08_2021) / (Banda03_2021 + Banda08_2021)
summary(IndexNDWI_2021)
plot(IndexNDWI_2021)



rcl1 <- matrix(c(
  -Inf, -0.6, 1,   # Classe 1: Urbano o suolo molto secco # Riga 1: Valori da -Inf a -0.6 saranno classificati come 1
  -0.6, -0.4, 2,   # Classe 2: Suolo secco/nudo # Riga 2: Valori da -0.6 a -0.4 saranno classificati come 2
  -0.4, 0, 3,      # Classe 3: Vegetazione scarsa  # Riga 3: Valori da -0.4 a 0 saranno classificati come 3
  0, 0.2, 4,       # Classe 4: Vegetazione ricca o aree umide # Riga 4: Valori da 0 a 0.2 saranno classificati come 4
  0.2, Inf, 5      # Classe 5: Acqua # Riga 5: Valori da 0.2 a Inf saranno classificati come 5
), ncol = 3, byrow = TRUE)



 
classified_2021 <- classify(IndexNDWI_2021, rcl1)

plot(classified_2021, col = viridis(100), main = "Classificazione 2021")

# calcolo la frequenza e la percentuale delle varie classi

FreqNDWI_2021 <- freq(classified_NDWI_2021)
FreqNDWI_2021
# per la 1° classe: 277968; 2° classe: 602088; 3° classe: 465964; 4° classe: 475; 5° classe: 1005 pixels

tot2021 <- ncell(NDWI_2021)
tot2021
#il numero di celle del raster NDWI_2021 sono 1347500 che è lo stesso di quello per IndexNDWI_2021
#la proporzione è la frequenza diviso il totale
prop2021 = FreqNDWI_2021 / tot2021
prop2021
# La 1° classe: 0.2062842301 20,63%; 2° classe: 0.4468185529 44,68%; 3° classe: 0.3457988868  34,58%; 4° classe: 0.0003525046 0.04%; 5° classe: 0.0007458256 0.07%

dev.off()






#Calcolo indici anno 2022
setwd("C:/Users/kiko9/Downloads/esametele/2022")
list.files("C:/Users/kiko9/Downloads/esametele/2022")



NDWI_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_NDWI.tiff")
TRUECOL_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_True_color.tiff")
SWIR_2022 <- rast ("2022-05-28-00_00_2022-05-28-23_59_Sentinel-2_L1C_SWIR.tiff")
par(mfrow=c(1,3))
plot(TRUECOL_2022)
plot(NDWI_2022)
plot(SWIR_2022)

dev.off()


#NDWI_2022 ha valori più elevati di 1
#Puoi normalizzare i valori del raster per farli rientrare nell'intervallo [0,1] utilizzando il range attuale (Min e Max)
NDWI_2022_normalized <- (NDWI_2022 - min_value) / (max_value - min_value)
summary(NDWI_2022_normalized)
im.plotRGB.auto(NDWI_2022_normalized)

IndexNDWI_2022 <-  (Banda03_2022 - Banda08_2022) / (Banda03_2022 + Banda08_2022)
summary(IndexNDWI_2022)
plot(IndexNDWI_2022)
dev.off()

#calcolo NDVI

NDVI_2022 <- (Banda08_2022 - Banda04_2022) / (Banda08_2022 + Banda04_2022)
summary(NDVI_2022)
veg_mask_2022 <- NDVI_2022 > 0.3
plot(veg_mask_2022, main = "Maschera Vegetazione 2022")

#classificazione in classi

im.plotRGB.auto (NDWI_2022_normalized, main= "Normalize Difference Water Index 2022") #posso anche non farlo
IndexNDWI_2022 <-  (Banda03_2022 - Banda08_2022) / (Banda03_2022 + Banda08_2022)
summary(IndexNDWI_2022)
plot(IndexNDWI_2022)



rcl2 <- matrix(c(
  -Inf, -0.6, 1,   # Classe 1: Urbano o suolo molto secco # Riga 1: Valori da -Inf a -0.6 saranno classificati come 1
  -0.6, -0.4, 2,   # Classe 2: Suolo secco/nudo # Riga 2: Valori da -0.6 a -0.4 saranno classificati come 2
  -0.4, -0.2, 3,      # Classe 3: Vegetazione scarsa  # Riga 3: Valori da -0.4 a -0.2 saranno classificati come 3
  -0-2, 0, 4,       # Classe 4: Vegetazione ricca o aree umide # Riga 4: Valori da -0.2 a 0 saranno classificati come 4
  0, Inf, 5      # Classe 5: Acqua # Riga 5: Valori da 0 a Inf saranno classificati come 5
), ncol = 3, byrow = TRUE)

 
classified_2022 <- classify (IndexNDWI_2022, rcl2)

plot (classified_2022, col = viridis(100), main = "Classificazione 2022")

# calcolo la frequenza e la percentuale delle varie classi

FreqNDWI_2022 <- freq(classified_NDWI_2022)
FreqNDWI_2022
# per la 1° classe: 46402; 2° classe: 798995; 3° classe: 453109; 4° classe: 47862; 5° classe: 1132 pixels

tot2022 <- ncell(NDWI_2022)
tot2022
#il numero di celle del raster NDWI_2021 sono 1347500 che è lo stesso di quello per IndexNDWI_2021
#la proporzione è la frequenza diviso il totale
prop2022 = FreqNDWI_2022 / tot2022
prop2022
# La 1° classe: 0.0344356215 3,44%; 2° classe:  0.5929461967 59,29%; 3° classe: 0.3362589981  33,63%; 4° classe: 0.0355191095 3.55%; 5° classe: 0.0008400742 0.08%

dev.off()


#Calcolo indici spettrali Anno 2023

setwd("C:/Users/kiko9/Downloads/esametele/2023")
list.files("C:/Users/kiko9/Downloads/esametele/2023")


NDWI_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_NDWI.tiff")
TRUECOL_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_True_color.tiff")
SWIR_2023 <- rast ("2023-05-23-00_00_2023-05-23-23_59_Sentinel-2_L1C_SWIR.tiff")
par(mfrow=c(1,3))
plot(TRUECOL_2023)
plot(NDWI_2023)
plot(SWIR_2023)

dev.off()

#calcolo NDVI

NDVI_2023 <- (Banda08_2023 - Banda04_2023) / (Banda08_2023 + Banda04_2023)
summary(NDVI_2023)
veg_mask_2023 <- NDVI_2023 > 0.3
plot(veg_mask_2023, main = "Maschera Vegetazione 2023")

#classificazione in classi

plot (NDWI_2023, main= "Normalize Difference Water Index 2023")
IndexNDWI_2023 <-  (Banda03_2023 - Banda08_2023) / (Banda03_2023 + Banda08_2023)
summary(IndexNDWI_2023)
plot(IndexNDWI_2023)



rcl3 <- matrix(c(
  -Inf, -0.6, 1,   # Classe 1: Urbano o suolo molto secco # Riga 1: Valori da -Inf a -0.6 saranno classificati come 1
  -0.6, -0.4, 2,   # Classe 2: Suolo secco/nudo # Riga 2: Valori da -0.6 a -0.4 saranno classificati come 2
  -0.4, 0, 3,      # Classe 3: Vegetazione scarsa  # Riga 3: Valori da -0.4 a -0.2 saranno classificati come 3
  0, 0.2, 4,       # Classe 4: Vegetazione ricca o aree umide # Riga 4: Valori da -0.2 a 0 saranno classificati come 4
  0.2, Inf, 5      # Classe 5: Acqua # Riga 5: Valori da 0 a Inf saranno classificati come 5
), ncol = 3, byrow = TRUE)

 
classified_2023 <- classify (IndexNDWI_2023, rcl3)

plot (classified_2023, col = viridis(100), main = "Classificazione 2023")

# calcolo la frequenza e la percentuale delle varie classi

FreqNDWI_2023 <- freq(classified_NDWI_2023)
FreqNDWI_2023
# per la 1° classe: 127944; 2° classe: 584629; 3° classe: 475603; 4° classe: 56444; 5° classe: 102880 pixels

tot2023 <- ncell(NDWI_2023)
tot2023
#il numero di celle del raster NDWI_2021 sono 1347500 che è lo stesso di quello per IndexNDWI_2021
#la proporzione è la frequenza diviso il totale
prop2023 = FreqNDWI_2023 / tot2023
prop2023
# La 1° classe: 0.09494917 9.49%; 2° classe:  0.43386197 43,39%; 3° classe: 0.35295213  35,30%; 4° classe: 0.04188794 4.19%; 5° classe: 0.07634879 7.63%
dev.off()


#Calcolo indici spettrali Anno 2024

setwd("C:/Users/kiko9/Downloads/esametele/2024")
list.files("C:/Users/kiko9/Downloads/esametele/2024")


NDWI_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_NDWI.tiff")
TRUECOL_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_True_color.tiff")
SWIR_2024 <- rast ("2024-05-24-00_00_2024-05-24-23_59_Sentinel-2_L1C_SWIR.tiff")
par(mfrow=c(1,3))
plot(TRUECOL_2024)
plot(NDWI_2024)
plot(SWIR_2024)
#stesso problema con la banda SWIR del 2024 cos+ come per l'NDWI del 2022

dev.off()

#calcolo NDVI

NDVI_2024 <- (Banda08_2024 - Banda04_2024) / (Banda08_2024 + Banda04_2024)
summary(NDVI_2024)
veg_mask_2024 <- NDVI_2024 > 0.3
plot(veg_mask_2024, main = "Maschera Vegetazione 2024")

#classificazione in classi

plot (NDWI_2024, main= "Normalize Difference Water Index 2024")
IndexNDWI_2024 <-  (Banda03_2024 - Banda08_2024) / (Banda03_2024 + Banda08_2024)
summary(IndexNDWI_2024)
plot(IndexNDWI_2024)



rcl4 <- matrix(c(
  -Inf, -0.6, 1,   # Classe 1: Urbano o suolo molto secco # Riga 1: Valori da -Inf a -0.6 saranno classificati come 1
  -0.6, -0.4, 2,   # Classe 2: Suolo secco/nudo # Riga 2: Valori da -0.6 a -0.4 saranno classificati come 2
  -0.4, 0, 3,      # Classe 3: Vegetazione scarsa  # Riga 3: Valori da -0.4 a -0.2 saranno classificati come 3
  0, 0.2, 4,       # Classe 4: Vegetazione ricca o aree umide # Riga 4: Valori da -0.2 a 0 saranno classificati come 4
  0.2, Inf, 5      # Classe 5: Acqua # Riga 5: Valori da 0 a Inf saranno classificati come 5
), ncol = 3, byrow = TRUE)

 
classified_2024 <- classify (IndexNDWI_2024, rcl4)

plot (classified_2024, col = viridis(100), main = "Classificazione 2024")

# calcolo la frequenza e la percentuale delle varie classi

FreqNDWI_2024 <- freq(classified_NDWI_2024)
FreqNDWI_2024
# per la 1° classe: 191542; 2° classe: 728044; 3° classe: 426586; 4° classe: 385; 5° classe: 943 pixels

tot2024 <- ncell(NDWI_2024)
tot2024
#numero di celle per il raster 1347500
#la proporzione è la frequenza diviso il totale
prop2024 = FreqNDWI_2024 / tot2024
prop2024
# La 1° classe: 0.1421461967 14.21%; 2° classe: 0.5402923933 54,03%; 3° classe: 0.3165758813  31.66%; 4° classe: 0.0002857143 0.03%; 5° classe: 0.0006998145 0.07%
dev.off()




par(mfrow = c(2,3))
plot(IndexNDWI_2020, main="NDWI 2020")
plot(IndexNDWI_2021, main="NDWI 2021")
plot(IndexNDWI_2022, main="NDWI 2022")
plot(IndexNDWI_2023, main="NDWI 2023")
plot(IndexNDWI_2024, main="NDWI 2024")
dev.off()




# costruisco un dataframe con le % delle diverse superfici classificate.
classi <- c("arido", "nudo", "veg.scarsa", "aree.umide", "acqua")
perc_2020 <- c(10.90, 51.77, 37.19, 0.08, 0.06)
perc_2021<- c(20.63, 44.68, 34.58, 0.04, 0.07)
perc_2022 <- c(3.44, 59.29, 33.63, 3.55, 0.08)
perc_2023 <- c(9.49, 43.39, 35.30, 4.19, 7.63)
perc_2024 <- c(14.21, 54.03, 31.66, 0.03, 0.07)
# crea un dataframe combinando il vettore classi e le % di ciascuna superficie.
tabout <- data.frame(classi, perc_2020, perc_2021, perc_2022, perc_2023, perc_2024)
View(tabout)

#ggplot per creare un grafico a barre relativo alle % dei vari anni
bar_2020 <-ggplot(tabout, aes(x=classi, y=perc_2020, fill=classi)) + geom_bar(stat="identity") + ylab("% di copertura 2020")
bar_2021 <-ggplot(tabout, aes(x=classi, y=perc_2021, fill=classi)) + geom_bar(stat="identity") + ylab("% di copertura 2021")
#la scala tra i due grafici è diversa
#come ovviare il problema: basta mettere gli assi uguali
#la funzione è ylim()
#ci vuole la c perché sono due elementi del vettore, ricordandoci la doppia parentesi
#questa è proprio una funzione che si chiama ylim()
# varying axis and using lines
#ylim(c(0,100))
bar_2020 <- ggplot(tabout, aes(x=classi, y=perc_2020, color=classi)) + geom_bar(stat="identity", fill="white") + ylab("% di copertura 2020") + ylim(c(0,100)) 
bar_2020
bar_2021 <- ggplot(tabout, aes(x=classi, y=perc_2021, color=classi)) + geom_bar(stat="identity",fill="white") + ylab("% di copertura 2021") + ylim(c(0,100))  
bar_2021
bar_2022 <- ggplot(tabout, aes(x=classi, y=perc_2022, color=classi)) + geom_bar(stat="identity",fill="white") + ylab("% di copertura 2022") + ylim(c(0,100))  
bar_2022
bar_2023 <- ggplot(tabout, aes(x=classi, y=perc_2023, color=classi)) + geom_bar(stat="identity",fill="white") + ylab("% di copertura 2023") + ylim(c(0,100)) 
bar_2023
bar_2024 <- ggplot(tabout, aes(x=classi, y=perc_2024, color=classi)) + geom_bar(stat="identity",fill="white") + ylab("% di copertura 2024") + ylim(c(0,100))
bar_2024

#patchwork
bar_2020 + bar_2021 + bar_2022 + bar_2023 + bar_2024

dev.off()


# MNDWI
# MNDWI  è un indice utilizzato per identificare le aree d'acqua su immagini satellitari, modificato rispetto all'NDWI classico.
# valori positivi indicano la presenza di acqua.
# valori negativi o vicini a zero indicano terreno asciutto o vegetazione.

MNDWI_2020 <- ( Banda03_2020 - Banda12_2020) / ( Banda03_2020 + Banda12_2020)
summary(MNDWI_2020)
plot(MNDWI_2020, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2020")
# "darkgoldenrod" per il suolo secco, "darkorange" per le zone di transizione, "deepskyblue" per l'acqua
Maschera_acqua_2020 <- MNDWI_2020 > 0.4
# il valore soglia lo sposto fino a 0.4 per ridurre la probabilità di falsi positivi come i campi agricoli ampiamente irrigati e le nuvole
#visualizzazione della maschera
plot(Maschera_acqua_2020, main="Maschera acqua 2020", legend=TRUE)

#questa riga calcola il numero totale di pixel classificati come "acqua" nella maschera
n_pixel_acqua_2020MNDWI <- sum(Maschera_acqua_2020[], na.rm = TRUE)
n_pixel_acqua_2020MNDWI
# Visualizzo il numero di pixel con acqua -> 4268
totMNDWI <- ncell(MNDWI_2020)
totMNDWI
# il totale è 1347500
# calcolo una % dei pixel mascherati sul totale dei pixel nell'immagine che mi indicano zone d'acqua
pMNDWI_2020 <- n_pixel_acqua_2020MNDWI/totMNDWI
pMNDWI_2020 
#la percentuale è 0.003167347 * 100 =0.32%

#Anno 2021

MNDWI_2021 <- ( Banda03_2021 - Banda12_2021) / ( Banda03_2021 + Banda12_2021)
summary(MNDWI_2021)
plot(MNDWI_2021, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2021")
# "darkgoldenrod" per il suolo secco, "darkorange" per le zone di transizione, "deepskyblue" per l'acqua
Maschera_acqua_2021 <- MNDWI_2021 > 0.4
# il valore soglia lo sposto  a 0.4 per ridurre la probabilità di falsi positivi come i campi agricoli ampiamente irrigati
#visualizzazione della maschera
plot(Maschera_acqua_2021, main="Maschera acqua 2021", legend=TRUE)

n_pixel_acqua_2021MNDWI <- sum(Maschera_acqua_2021[], na.rm = TRUE)
n_pixel_acqua_2021MNDWI
# Visualizzo il numero di pixel con acqua -> 2068
totMNDWI
# il totale è 1347500
# calcolo una % dei pixel mascherati sul totale dei pixel nell'immagine che mi indicano zone d'acqua
pMNDWI_2021 <- n_pixel_acqua_2021MNDWI/totMNDWI
pMNDWI_2021 
#la percentuale è 0.001534694 * 100 =  0.15%

#Anno 2022

MNDWI_2022 <- ( Banda03_2022 - Banda12_2022) / ( Banda03_2022 + Banda12_2022)
summary(MNDWI_2022)
plot(MNDWI_2022, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2022")
# "darkgoldenrod" per il suolo secco, "darkorange" per le zone di transizione, "deepskyblue" per l'acqua
Maschera_acqua_2022 <- MNDWI_2022 > 0.4
# il valore soglia lo sposto  a 0.4 per ridurre la probabilità di falsi positivi come i campi agricoli ampiamente irrigati
#visualizzazione della maschera
plot(Maschera_acqua_2022, main="Maschera acqua 2022", legend=TRUE)

n_pixel_acqua_2022MNDWI <- sum(Maschera_acqua_2022[], na.rm = TRUE)
n_pixel_acqua_2022MNDWI
# Visualizzo il numero di pixel con acqua -> 1171
totMNDWI
# il totale è 1347500
# calcolo una % dei pixel mascherati sul totale dei pixel nell'immagine che mi indicano zone d'acqua
pMNDWI_2022 <- n_pixel_acqua_2022MNDWI/totMNDWI
pMNDWI_2022 
#la percentuale è 0.0008690167 * 100 =  0.09%

#Anno 2023

MNDWI_2023 <- ( Banda03_2023 - Banda12_2023) / ( Banda03_2023 + Banda12_2023)
summary(MNDWI_2023)
plot(MNDWI_2023, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2023")
# "darkgoldenrod" per il suolo secco, "darkorange" per le zone di transizione, "deepskyblue" per l'acqua
Maschera_acqua_2023 <- MNDWI_2023 > 0.4
# il valore soglia lo sposto  a 0.4 per ridurre la probabilità di falsi positivi come i campi agricoli ampiamente irrigati
#visualizzazione della maschera
plot(Maschera_acqua_2023, main="Maschera acqua 2023", legend=TRUE)

n_pixel_acqua_2023MNDWI <- sum(Maschera_acqua_2023[], na.rm = TRUE)
n_pixel_acqua_2023MNDWI
# Visualizzo il numero di pixel con acqua -> 228831
totMNDWI
# il totale è 1347500
# calcolo una % dei pixel mascherati sul totale dei pixel nell'immagine che mi indicano zone d'acqua
pMNDWI_2023 <- n_pixel_acqua_2023MNDWI/totMNDWI
pMNDWI_2023 
#la percentuale è  0.1698189 * 100 =  17%

#Anno 2024

MNDWI_2024 <- ( Banda03_2024 - Banda12_2024) / ( Banda03_2024 + Banda12_2024)
summary(MNDWI_2024)
plot(MNDWI_2024, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2024")
# "darkgoldenrod" per il suolo secco, "darkorange" per le zone di transizione, "deepskyblue" per l'acqua
Maschera_acqua_2024 <- MNDWI_2024 > 0.4
# il valore soglia lo sposto  a 0.4 per ridurre la probabilità di falsi positivi come i campi agricoli ampiamente irrigati
#visualizzazione della maschera
plot(Maschera_acqua_2024, main="Maschera acqua 2024", legend=TRUE)

n_pixel_acqua_2024MNDWI <- sum(Maschera_acqua_2024[], na.rm = TRUE)
n_pixel_acqua_2024MNDWI
# Visualizzo il numero di pixel con acqua -> 3533
totMNDWI
# il totale è 1347500
# calcolo una % dei pixel mascherati sul totale dei pixel nell'immagine che mi indicano zone d'acqua
pMNDWI_2024 <- n_pixel_acqua_2024MNDWI/totMNDWI
pMNDWI_2024 
#la percentuale è 0.002621892 * 100 =  0.26%

dev.off()

par(mfrow=c(2,3))
plot(MNDWI_2020, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2020")
plot(MNDWI_2021, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2021")
plot(MNDWI_2022, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2022")
plot(MNDWI_2023, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2023")
plot(MNDWI_2024, col=colorRampPalette(c("darkgoldenrod", "darkorange", "deepskyblue"))(100), main="MNDWI 2024")

dev.off()

par(mfrow=c(2,3))
plot(Maschera_acqua_2020, main="Maschera acqua 2020", legend=TRUE)
plot(Maschera_acqua_2021, main="Maschera acqua 2021", legend=TRUE)
plot(Maschera_acqua_2022, main="Maschera acqua 2022", legend=TRUE)
plot(Maschera_acqua_2023, main="Maschera acqua 2023", legend=TRUE)
plot(Maschera_acqua_2024, main="Maschera acqua 2024", legend=TRUE)

dev.off()

# differenze per vedere e analizzare come la disponibilità del volume d'acqua sia cambiata tra i vari anni

MNDWI_diff <- MNDWI_2024 - MNDWI_2023
cldiff <- colorRampPalette(c("red", "white", "blue"))(100)
plot(MNDWI_diff, col=cldiff, main= "Differenza MNDWI 2024 - 2023")

par(mfrow = c(1,3))

MNDWI_diff2 <- MNDWI_2023 - MNDWI_2022
plot(MNDWI_diff2, col=cldiff, main= "Differenza MNDWI 2023 - 2022")

MNDWI_diff3 <- MNDWI_2022 - MNDWI_2021
plot(MNDWI_diff3, col=cldiff, main= "Differenza MNDWI 2022 - 2021")

MNDWI_diff4 <- MNDWI_2021 - MNDWI_2020
plot(MNDWI_diff4, col=cldiff, main= "Differenza MNDWI 2021 - 2020")

dev.off()

par(mfrow=c(1,3))

MNDWI_diff5 <- MNDWI_2023 - MNDWI_2022
plot(MNDWI_diff5, col=cldiff, main="Differenza MNDWI 20223 - 2022")

MNDWI_diff6 <- MNDWI_2023 - MNDWI_2021
plot(MNDWI_diff6, col=cldiff, main="Differenza MNDWI 2023 - 2021")

MNDWI_diff7 <- MNDWI_2023 - MNDWI_2020
plot(MNDWI_diff7, col=cldiff, main="Differenza MNDWI 2023 - 2020")


#NDWI










